<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroTracker</title>
    <style>
        /* --- ESTILOS CSS NATIVOS (Sin dependencias externas) --- */
        :root {
            --primary: #059669; /* Emerald 600 */
            --primary-dark: #047857;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --radius: 16px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 80px; }
        
        /* Layout */
        .container { max-width: 480px; margin: 0 auto; background: var(--surface); min-height: 100vh; position: relative; }
        .p-4 { padding: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .hidden { display: none !important; }

        /* Componentes */
        .card { background: var(--surface); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); border: 1px solid #e2e8f0; margin-bottom: 12px; position: relative; }
        .card.dark { background: #0f172a; color: white; border: none; }
        
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; transition: transform 0.1s; width: 100%; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-dark { background: #0f172a; color: white; }
        .btn-icon { background: transparent; padding: 8px; color: #94a3b8; width: auto; }
        .btn-fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #0f172a; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 100; }

        .input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f8fafc; font-size: 14px; margin-bottom: 12px; }
        .label { font-size: 12px; font-weight: bold; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; display: block; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; border: 1px solid transparent; }
        .badge.Insecticida { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .badge.Fungicida { background: #ffedd5; color: #c2410c; border-color: #fed7aa; }
        .badge.Abono { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .badge.Herbicida { background: #dbfc66; color:#15903a; border-color: #fedada  }
        .badge.Riego { background: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; }
        .status-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-content { transform: translateY(0); }

        /* Navbar */
        .navbar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 12px; z-index: 90; max-width: 480px; margin: 0 auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 10px; font-weight: bold; background: none; border: none; width: 100%; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; }

        /* Iconos SVG */
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* Estilo para el modal de confirmación */
        .modal-confirm-content {
            background: white;
            border-radius: 12px;
            max-width: 300px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="p-4" id="app-content">
        <!-- El contenido se inyecta aquí con JS -->
    </div>
</div>

<!-- Navbar -->
<nav class="navbar">
    <button class="nav-item active" onclick="switchTab('dashboard')" id="nav-dashboard">
        <svg class="icon" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        INICIO
    </button>
    <button class="nav-item" onclick="switchTab('crops')" id="nav-crops">
        <svg class="icon" viewBox="0 0 24 24"><path d="M7 20h10"/><path d="M10 20c5.5-2.5.8-6.4 3-10"/><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.2.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1.7-1.3 2.9-3.3 3-5.5-1.4-1.3-3.5-1.7-6.2-1.1z"/></svg>
        CULTIVOS
    </button>
    <button class="nav-item" onclick="switchTab('history')" id="nav-history">
        <svg class="icon" viewBox="0 0 24 24"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
        BITÁCORA
    </button>
</nav>

<!-- Modal Registro -->
<div class="modal-overlay" id="logModal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h2 style="margin:0; font-size: 20px;">Registrar Aplicación</h2>
            <button class="btn-icon" onclick="closeModal()">✕</button>
        </div>
        <form id="logForm" onsubmit="handleLogSubmit(event)">
            <input type="hidden" name="planId" id="modalPlanId">
            <label class="label">Cultivo</label>
            <select name="cropId" id="modalCropId" class="input" required></select>
            
            <div class="grid-2">
                <div>
                    <label class="label">Tipo</label>
                    <select name="type" id="modalType" class="input">
                        <option value="Insecticida">Insecticida</option>
                        <option value="Fungicida">Fungicida</option>
                        <option value="Abono">Abono</option>
                        <option value="Herbicida">Herbicida</option>
                        <option value="Riego">Riego</option>
                    </select>
                </div>
                <div>
                    <label class="label">Fecha</label>
                    <input type="date" name="date" id="modalDate" class="input" required>
                </div>
            </div>
            
            <label class="label">Producto</label>
            <input name="product" id="modalProduct" class="input" placeholder="Ej: Urea" required>
            
            <label class="label">Dosis / Notas</label>
            <input name="notes" id="modalNotes" class="input" placeholder="Ej: 500ml - Clima lluvioso">
            
            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">GUARDAR</button>
        </form>
    </div>
</div>

<button class="btn-fab" id="fabBtn" onclick="openModal()">
    <svg class="icon" style="width:28px; height:28px;" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
</button>

<script>
    // --- LÓGICA DE LA APLICACIÓN (VANILLA JS) ---
    
    // 1. Estado y Persistencia
    // Variables globales para Firestore (no usadas en esta versión sin dependencias)
    const __app_id = 'agrotracker-app-id';
    const __firebase_config = '{}';
    const __initial_auth_token = '';

    const initialState = {
        crops: [{ id: 1, name: "Lote Ejemplo", type: "Tomate", date: "2023-10-01", location: "Sector 1" }],
        plans: [{ id: 1, cropId: 1, taskName: "Abono Inicial", frequency: 15, lastDate: new Date().toISOString().split('T')[0], type: "Abono" }],
        logs: []
    };

    // Usamos localStorage, que funciona perfectamente en web
    let state = JSON.parse(localStorage.getItem('agroState')) || initialState;
    let currentTab = 'dashboard';

    function saveState() {
        localStorage.setItem('agroState', JSON.stringify(state));
        render();
    }


    // 2. Utilidades de Fecha y Formato (MÁXIMA COMPATIBILIDAD - AHORA AL INICIO)
    
    const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

    function getStatus(nextDateStr) {
        const today = new Date(); today.setHours(0,0,0,0);
        const target = new Date(nextDateStr + 'T00:00:00'); target.setHours(0,0,0,0); 
        const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return { label: "ATRASADO", color: "#ef4444", bg: "#fef2f2" };
        if (diffDays === 0) return { label: "HOY", color: "#ea580c", bg: "#fff7ed" };
        if (diffDays <= 7) return { label: "ESTA SEMANA", color: "#2563eb", bg: "#eff6ff" };
        return { label: "FUTURO", color: "#64748b", bg: "#f1f5f9" };
    }

    function addDays(dateStr, days) {
        // Usamos una pequeña corrección para asegurar que la hora no afecte el cálculo
        const date = new Date(dateStr + 'T00:00:00');
        date.setDate(date.getDate() + parseInt(days));
        return date.toISOString().split('T')[0];
    }
    
    // Función de formato simple (fix de compatibilidad)
    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        } catch (e) {
            // Fallback en caso de error de fecha
            return dateStr;
        }
    }


    // 3. Renderizado (HTML Templates)
    function render() {
        const content = document.getElementById('app-content');
        const fab = document.getElementById('fabBtn');
        
        // Actualizar Tabs
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navItem = document.getElementById(`nav-${currentTab}`);
        if(navItem) navItem.classList.add('active');

        if (currentTab === 'dashboard') {
            fab.style.display = 'flex';
            renderDashboard(content);
        } else if (currentTab === 'crops') {
            fab.style.display = 'none';
            renderCrops(content);
        } else {
            fab.style.display = 'none';
            renderHistory(content);
        }
    }

    function renderDashboard(container) {
        // Calcular Alertas
        const alerts = state.plans.map(p => {
            const nextDate = addDays(p.lastDate, p.frequency);
            const status = getStatus(nextDate);
            const crop = state.crops.find(c => c.id == p.cropId);
            return { ...p, nextDate, status, cropName: crop ? crop.name : 'Borrado', isOrphan: !crop };
        }).sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));

        const pendingCount = alerts.filter(a => a.status.label === 'HOY' || a.status.label === 'ATRASADO').length;

        container.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h1 style="margin:0; font-size: 24px;">Hola, Agricultor</h1>
                <button class="btn-icon" onclick="resetApp()" style="color:#ef4444">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21.5 2v20H2v-2h17.5V4h-15V2z"/><path d="M10 8h2v8h-2zM6 10h2v4H6zM14 10h2v4h-2z"/></svg>
                </button>
            </div>

            <div class="grid-2 mb-4">
                <div class="card dark">
                    <span class="label" style="color:#94a3b8">Alertas Hoy</span>
                    <div style="font-size: 32px; font-weight: bold; color: #34d399">${pendingCount}</div>
                </div>
                <div class="card">
                    <span class="label">Cultivos Activos</span>
                    <div style="font-size: 32px; font-weight: bold;">${state.crops.length}</div>
                </div>
            </div>

            <h3 class="mb-4">Agenda de Trabajo</h3>
            ${alerts.length === 0 ? '<div style="text-align:center; color:#94a3b8; padding:40px;">Todo al día ✅</div>' : ''}
            
            ${alerts.map(task => `
                <div class="card" style="border-left: 4px solid ${task.status.color}">
                    <div class="flex justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge ${task.type}">${task.type}</span>
                                <span class="status-pill" style="color:${task.status.color}; background:${task.status.bg}">${task.status.label}</span>
                            </div>
                            <div style="font-weight:bold; font-size:16px;">${task.taskName}</div>
                            <div style="color:#64748b; font-size:14px;">${task.cropName}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="label">Próxima</div>
                            <div style="font-weight:bold;">${formatDate(task.nextDate)}</div>
                            ${!task.isOrphan ? 
                                `<button class="btn btn-dark" style="margin-top:8px; padding:6px 12px; font-size:12px;" 
                                  onclick="openModal(${task.cropId}, '${task.type}', ${task.id}, '${task.taskName.replace(/'/g, "\\'")}')">
                                  Registrar
                                </button>` : 
                                `<button onclick="deletePlan(${task.id})" style="color:red; background:none; border:none; margin-top:5px;">Eliminar</button>`
                            }
                        </div>
                    </div>
                </div>
            `).join('')}
        `;
    }

    function renderCrops(container) {
        container.innerHTML = `
            <h2 class="mb-4">Mis Cultivos</h2>
            
            ${state.crops.map(c => `
                <div class="card" style="border-left: 4px solid var(--primary)">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 style="margin:0 0 4px 0;">${c.name}</h3>
                            <div style="color:#64748b; font-size:14px;">${c.type} • ${c.location}</div>
                            <div style="font-size:12px; color:#94a3b8;">Plantado el ${formatDate(c.date)}</div>
                        </div>
                        <button onclick="deleteCrop(${c.id})" style="color:#cbd5e1; background:none; border:none; font-size:20px;">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M2 6h20"/><path d="M8 6h8V4a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2z"/></svg>
                        </button>
                    </div>
                    
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #f1f5f9;">
                        <div class="label">Planes Automáticos</div>
                        ${state.plans.filter(p => p.cropId == c.id).map(p => `
                            <div class="flex justify-between items-center" style="font-size:13px; margin-top:4px;">
                                <span>• ${p.taskName} (Cada ${p.frequency} días)</span>
                                <button onclick="deletePlan(${p.id})" style="color:red; background:none; border:none; padding: 0 4px;">✕</button>
                            </div>
                        `).join('') || '<span style="font-size:12px; color:#cbd5e1;">Sin planes</span>'}
                    </div>
                </div>
            `).join('')}

            <div class="card" style="border: 2px dashed #cbd5e1; margin-top:20px;">
                <h3 style="margin-top:0;">+ Nuevo Cultivo</h3>
                <form onsubmit="handleAddCrop(event)">
                    <input name="name" class="input" placeholder="Nombre (Ej: Lote Norte)" required>
                    <div class="grid-2">
                        <input name="type" class="input" placeholder="Variedad" required>
                        <input name="location" class="input" placeholder="Ubicación">
                    </div>
                    <label class="label">Fecha Siembra</label>
                    <input type="date" name="date" class="input" required>
                    <button class="btn btn-primary">GUARDAR CULTIVO</button>
                </form>
            </div>

            <div class="card" style="border: 2px dashed #cbd5e1;">
                <h3 style="margin-top:0;">⏱ Nueva Alerta Recurrente</h3>
                <form onsubmit="handleAddPlan(event)">
                    <select name="cropId" class="input" required>
                        <option value="" disabled selected>-- Seleccione Cultivo --</option>
                        ${state.crops.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                    <input name="taskName" class="input" placeholder="Tarea (Ej: Fertilizar)" required>
                    <div class="grid-2">
                        <select name="type" class="input">
                            <option value="Abono">Abono</option>
                            <option value="Insecticida">Insecticida</option>
                            <option value="Fungicida">Fungicida</option>
                            <option value="Herbicida">Herbicida</option>
                            <option value="Riego">Riego</option>
                        </select>
                        <input type="number" name="frequency" class="input" placeholder="Días (Frecuencia)" required>
                    </div>
                    <label class="label">Última vez realizado</label>
                    <input type="date" name="lastDate" class="input" required>
                    <button class="btn btn-dark">CREAR ALERTA</button>
                </form>
            </div>
        `;
    }

    function renderHistory(container) {
        container.innerHTML = `
            <h2 class="mb-4">Bitácora</h2>
            ${state.logs.length === 0 ? '<div style="text-align:center; color:#94a3b8; padding:20px;">No hay registros</div>' : ''}
            
            ${state.logs.slice().reverse().map(log => {
                const crop = state.crops.find(c => c.id == log.cropId);
                return `
                <div class="card flex gap-4 items-center">
                    <div style="text-align:center; min-width:50px;">
                        <div style="font-weight:900; font-size:20px;">${new Date(log.date).getDate()}</div>
                        <div style="font-size:10px; text-transform:uppercase;">${monthNames[new Date(log.date).getMonth()]}</div>
                    </div>
                    <div style="border-left: 2px solid #f1f5f9; padding-left:12px; flex:1;">
                        <div class="flex justify-between">
                            <div style="font-weight:bold;">${log.product}</div>
                            <span class="badge ${log.type}">${log.type}</span>
                        </div>
                        <div style="font-size:12px; color:var(--primary);">${crop ? crop.name : 'Cultivo eliminado'}</div>
                        <div style="font-size:12px; color:#64748b; margin-top:4px;">${log.notes || ''}</div>
                    </div>
                    <button onclick="deleteLog(${log.id})" style="color:#ef4444; background:none; border:none; font-size:18px;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
            `}).join('')}
        `;
    }

    // 4. Manejadores de Eventos (Actions)
    
    function switchTab(tab) {
        currentTab = tab;
        render();
    }

    function handleAddCrop(e) {
        e.preventDefault();
        const f = new FormData(e.target);
        if (f.get('name') && f.get('type') && f.get('date')) {
            state.crops.push({
                id: Date.now(),
                name: f.get('name'),
                type: f.get('type'),
                location: f.get('location'),
                date: f.get('date')
            });
            e.target.reset();
            saveState();
        }
    }

    function handleAddPlan(e) {
        e.preventDefault();
        const f = new FormData(e.target);
        if (f.get('cropId') && f.get('taskName') && f.get('frequency') && f.get('lastDate')) {
            state.plans.push({
                id: Date.now(),
                cropId: parseInt(f.get('cropId')),
                taskName: f.get('taskName'),
                type: f.get('type'),
                frequency: parseInt(f.get('frequency')),
                lastDate: f.get('lastDate')
            });
            e.target.reset();
            saveState();
            // Implementación simple de un modal de confirmación
            if (document.getElementById('app-content')) {
                document.getElementById('app-content').insertAdjacentHTML('beforebegin', `
                    <div id="temp-alert" style="position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#34d399; color:white; padding:10px 20px; border-radius:8px; z-index:1001; font-weight:bold;">
                        Alerta creada con éxito!
                    </div>
                `);
                setTimeout(() => document.getElementById('temp-alert')?.remove(), 3000);
            }
        }
    }

    function handleLogSubmit(e) {
        e.preventDefault();
        const f = new FormData(e.target);
        const newDate = f.get('date');
        
        // Guardar Log
        state.logs.push({
            id: Date.now(),
            cropId: parseInt(f.get('cropId')),
            type: f.get('type'),
            date: newDate,
            product: f.get('product'),
            notes: f.get('notes')
        });

        // Actualizar Plan si existe
        const planId = document.getElementById('modalPlanId').value;
        if(planId) {
            const plan = state.plans.find(p => p.id == parseInt(planId));
            if(plan) plan.lastDate = newDate;
        } else {
            // Lógica inteligente: actualizar plan si coincide cultivo y tipo
            const matchingPlan = state.plans.find(p => p.cropId == parseInt(f.get('cropId')) && p.type == f.get('type'));
            if(matchingPlan) matchingPlan.lastDate = newDate;
        }

        closeModal();
        saveState();
    }

    // Funciones de Borrado (Usando modal de confirmación simple)
    function showCustomConfirm(message, callback) {
        const modalId = 'custom-confirm-modal';
        
        // Remover cualquier modal anterior
        const existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();
        
        const modalHTML = `
            <div class="modal-overlay open" id="${modalId}" style="align-items: center; justify-content: center; background:rgba(0,0,0,0.7);">
                <div class="modal-content modal-confirm-content" style="transform:none;">
                    <p style="margin-top:0; font-weight:bold;">Confirmación</p>
                    <p>${message}</p>
                    <div class="flex gap-2 justify-between">
                        <button class="btn" style="background:#e2e8f0; color:#1e293b;" onclick="document.getElementById('${modalId}').remove(); window.runCallback(false);">Cancelar</button>
                        <button class="btn btn-danger" style="background:var(--danger); color:white;" onclick="document.getElementById('${modalId}').remove(); window.runCallback(true);">Confirmar</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Asignar el callback a una función global temporal
        // Usamos una función global simple para evitar problemas de alcance (scope)
        window.runCallback = (result) => {
            callback(result);
            delete window.runCallback;
        };
    }

    function deleteCrop(id) {
        showCustomConfirm('¿Eliminar cultivo? Se borrarán también sus alertas.', (confirmed) => {
            if(confirmed) {
                state.crops = state.crops.filter(c => c.id != id);
                state.plans = state.plans.filter(p => p.cropId != id);
                saveState();
            }
        });
    }
    
    function deletePlan(id) {
        showCustomConfirm('¿Dejar de recibir alertas para esta tarea?', (confirmed) => {
            if(confirmed) {
                state.plans = state.plans.filter(p => p.id != id);
                saveState();
            }
        });
    }

    function deleteLog(id) {
        showCustomConfirm('¿Borrar registro de la bitácora?', (confirmed) => {
            if(confirmed) {
                state.logs = state.logs.filter(l => l.id != id);
                saveState();
            }
        });
    }

    function resetApp() {
        showCustomConfirm('ATENCIÓN: Se borrarán todos los datos y volverá al estado inicial. ¿Continuar?', (confirmed) => {
            if(confirmed) {
                localStorage.removeItem('agroState');
                location.reload();
            }
        });
                                                 }
        // 5. Helpers UI (Modal)
    function openModal(cropId = null, type = 'Insecticida', planId = null, taskName = null) {
        const modal = document.getElementById('logModal');
        const cropSelect = document.getElementById('modalCropId');
        
        // Limpiar select
        cropSelect.innerHTML = ''; 
        if(state.crops.length === 0) {
            // Mostrar mensaje de error si no hay cultivos y salir
            showCustomConfirm('Necesitas añadir un Cultivo antes de registrar una aplicación.', () => {});
            return; 
        }

        // Llenar select de cultivos
        cropSelect.innerHTML = state.crops.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        // Pre-llenar datos
        if(cropId) cropSelect.value = cropId;
        document.getElementById('modalType').value = type;
        document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('modalPlanId').value = planId || '';
        document.getElementById('modalNotes').value = taskName ? `Tarea: ${taskName}` : '';
        document.getElementById('modalProduct').value = '';

        modal.classList.add('open');
    }

    function closeModal() {
        document.getElementById('logModal').classList.remove('open');
    }


    // 6. Inicialización
    // Llamar a render() inmediatamente después de que el script cargue
    try {
        render(); 
    } catch (e) {
        // En caso de error, muestra un mensaje de depuración
        document.getElementById('app-content').innerHTML = `
            <div style="padding: 20px; color: red; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px;">
                <strong>Error Crítico de Inicialización:</strong><br>
                El script principal no pudo ejecutarse.<br>
                Mensaje de error: ${e.message}
            </div>
        `;
        console.error("Error en la inicialización:", e);
    }
    
</script>
</body>
</html>
